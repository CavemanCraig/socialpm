<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
      "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xml:lang="en" lang="en" xmlns="http://www.w3.org/1999/xhtml"
	xmlns:c="http://java.sun.com/jsp/jstl/core"
	xmlns:f="http://java.sun.com/jsf/core"
	xmlns:h="http://java.sun.com/jsf/html"
	xmlns:ui="http://java.sun.com/jsf/facelets"
	xmlns:ocp="http://java.sun.com/jsf/composite/ocpcommon"
	xmlns:pretty="http://ocpsoft.com/prettyfaces"
	xmlns:socialpm="http://java.sun.com/jsf/composite/socialpm"
	xmlns:a="http://java.sun.com/jsf/composite/ajax">

<ui:composition template="/WEB-INF/view/templates/socialpm.xhtml">
	<ui:param name="title"
		value="#{currentProjectBean.project.name} &#187; Backlog" />

	<ui:define name="header">
		<h2>&#171; Backlog</h2>
	</ui:define>

	<!-- Override and remove default messaging -->
	<ui:define name="messages">
	</ui:define>

	<ui:define name="content">
		<h:form id="filterform" autocomplete="off">
			<div class="box-bordered p5 m5b">
			<h4>Filter</h4>
			<h:panelGroup rendered="#{!empty backlogBean.storyNumber}">
				<div
					class="fl p5 m5r box-shaded #{backlogBean.storyNumberSet ? 'border-red' : 'border-grey' }">
				<label>Number:</label><br />
				<h:inputText value="#{backlogBean.storyNumber}"
					style="margin-top: 2px;" disabled="true" size="3" /></div>
			</h:panelGroup>
			
			<div
				class="fl p5 m5r box-shaded #{backlogBean.statusFilterSet ? 'border-red' : 'border-grey' }">
			<label for="statusFilter">Status:</label><br />
			<h:selectOneMenu id="statusFilter" autocomplete="off"
				value="#{backlogBean.statusFilter}">
				<f:selectItems value="#{backlogBean.storyStatusOptions}" />
			</h:selectOneMenu></div>
			
			<div
				class="fl p5 m5r box-shaded #{backlogBean.descriptionFilterSet ? 'border-red' : 'border-grey' }">
			<label for="descriptionFilter">Description:</label><br />
			<h:inputText style="margin-top: 2px;" size="15"
				value="#{backlogBean.descriptionFilter}" /></div>
				
			<div
				class="fl p5 m5r box-shaded #{backlogBean.featureFilterSet ? 'border-red' : 'border-grey' }">
			<label for="featureFilter">Feature:</label><br />
			<h:selectOneMenu id="featureFilter" autocomplete="off"
				value="#{backlogBean.featureFilter}">
				<f:selectItems value="#{backlogBean.storyFeatureOptions}" />
			</h:selectOneMenu></div>
			
			<div
				class="fl p5 m5r box-shaded #{backlogBean.iterationFilterSet ? 'border-red' : 'border-grey' }">
			<label for="iterationFilter">Iteration:</label><br />
			<h:selectOneMenu id="iterationFilter" autocomplete="off"
				value="#{backlogBean.iterationFilter}" style="width: 135px;">
				<f:selectItems value="#{backlogBean.storyIterationOptions}" />
			</h:selectOneMenu></div>
			
			<div
				class="fl p5 m5r box-shaded #{backlogBean.milestoneFilterSet ? 'border-red' : 'border-grey' }">
			<label for="milestoneFilter">Milestone:</label><br />
			<h:selectOneMenu id="milestoneFilter" autocomplete="off"
				value="#{backlogBean.milestoneFilter}"  style="width: 135px;" >
				<f:selectItems value="#{backlogBean.storyMilestoneOptions}" />
			</h:selectOneMenu></div>
			
			<div
				class="fl p5 m5r box-shaded #{backlogBean.anyFilterSet ? 'border-red' : 'border-grey' }">
			<label for="filter">Filter:</label><br />
			<h:commandButton id="filter" value="Apply"
				action="#{backlogBean.doFilter}" /> <h:commandButton id="clear"
				class="faded" value="Clear" action="#{backlogBean.clearFilter}" />
			</div>
			<div class="clearing"></div>
			</div>
		</h:form>

		<h:form id="backlogForm" autocomplete="off">
			<ocp:messages globalOnly="true" />

			<h:dataTable id="stories" var="story" value="#{backlogBean.stories}"
				styleClass="tbl" rowClasses="odd, even" forceId="false" width="100%"
				forceIdIndexFormula="#{story.number}">
				<h:column align="center">
					<f:facet name="header">
						<h:outputText value="#" />
					</f:facet>
					<h:outputText value="#{story.number}" />
				</h:column>
				
				<h:column>
					<f:facet name="header">
						<h:outputText value="Priority" />
					</f:facet>
					<label for="priority"><ocp:message for="priority" /></label>
					<input id="tableSorterPriorityHack" type="hidden"
						value="#{story.priority}" />
					<h:inputText id="priority" value="#{story.priority}" size="4"
						autocomplete="off" validator="#{backlogBean.validatePriority}"
						valueChangeListener="#{backlogBean.updatePriority}">
						<f:ajax execute="priority" render="@form" />
					</h:inputText>
				</h:column>
				
				<h:column>
					<f:facet name="header">
						<h:outputText value="Description" />
					</f:facet>
					<pretty:link mappingId="#{urlConstants.VIEW_STORY}" 
						styleClass="block p5 box-bordered" style="color: #333; background-color: #FFFF99;">
						<f:param value="#{backlogBean.project.name}" />
						<f:param value="#{story.number}" />
						<h:outputText value="#{story.description}" />
					</pretty:link>
				</h:column>
				
				<h:column>
					<f:facet name="header">
						<h:outputText value="Status" />
					</f:facet>
					<h:outputText value="#{story.status}" />
				</h:column>
				
				<h:column>
					<f:facet name="header">
						<h:outputText value="Feature" />
					</f:facet>
					<h:outputText value="#{story.feature.name}" />
				</h:column>
				
				<h:column>
					<f:facet name="header">
						<h:outputText value="Milestone" />
					</f:facet>
					<h:selectOneMenu id="milestone" style="width: 100px;"
						disabled="#{story.status ne 'OPEN'}" value="#{story.milestone.name}"
						autocomplete="off" valueChangeListener="#{backlogBean.updateMilestone}">
						<f:ajax execute="milestone" render="@form" />
						<f:selectItem noSelectionOption="true" itemLabel="---"/>
						<f:selectItems var="m" itemLabel="#{m.name}" itemValue="#{m.name}"
							value="#{currentProjectBean.project.milestones}"
							itemDisabled="#{m.past and story.milestone != i}" />
					</h:selectOneMenu>
				</h:column>
				
				<h:column>
					<f:facet name="header">
						<h:outputText value="Iteration" />
					</f:facet>
					<h:selectOneMenu id="iteration" autocomplete="off" style="width: 100px;"
						disabled="#{story.status ne 'OPEN'}"
						value="${story.iteration.title}"
						valueChangeListener="#{backlogBean.updateIteration}">
						<f:ajax execute="iteration" render="@form" />
						<f:selectItems var="i" itemLabel="#{i.title}" itemValue="#{i.title}"
							value="#{currentProjectBean.project.iterations}" 
							itemDisabled="#{i.ended and story.iteration != i}" />
					</h:selectOneMenu>
				</h:column>
			</h:dataTable>
		</h:form>
        
	</ui:define>
</ui:composition>
</html>